<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<!-- Prevent mobile auto zoom -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Visit Task</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #000;
    color: #000;
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    overflow: hidden;
  }

  .top-banner {
    width: 100%;
    background: #000;
    color: #fff;
    padding: 18px 20px;
    font-weight: 700;
    font-size: 18px;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    white-space: normal;
    line-height: 1.4;
  }

  /* Small defensive rule so "Seconds" never loses its last character */
  .top-banner .seconds {
    display: inline-block;
    padding-right: 6px; /* ensures the final glyph has breathing room */
    box-sizing: border-box;
  }

  /* The iframe now fills all space below the banner */
  .preview {
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    bottom: 0;
    border: none;
    width: 100%;
    height: calc(100vh - 70px);
    background: #000;
  }

  iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* ---------- INVALID DESIGN ---------- */
  .invalid-root { all: initial; box-sizing: border-box; }
  .invalid-root * { box-sizing: border-box; }
  .invalid-body {
    margin: 0;
    background: #000;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  .invalid-center-message {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 28px;
    font-weight: 800;
    color: #000;
    padding: 25px 50px;
    background: #b59a3a;
    border-radius: 20px;
    animation: invalid-float 3s ease-in-out infinite;
    white-space: pre-line;
    line-height: 1.5;
  }
  .invalid-center-message a {
    color: #000;
    text-decoration: none;
    font-weight: 800;
  }
  .invalid-telegram-line {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }
  .invalid-telegram-logo {
    width: 28px;
    height: 28px;
  }
  @keyframes invalid-float {
    0%,100%{transform:translateY(0);}
    50%{transform:translateY(-10px);}
  }
</style>
</head>
<body>
<div id="appRoot"></div>

<script>
const INVALID_MARKUP = `
  <div class="invalid-root">
    <div class="invalid-body">
      <div id="centerMessage" class="invalid-center-message"></div>
    </div>
  </div>
`;
const INVALID_LINES = [
  "Nothing To Do Here!",
  "Join My Bot To Get",
  "Visit Task",
  "@mybot"
];
function startInvalidTyping() {
  const center = document.getElementById("centerMessage");
  if (!center) return;
  center.innerHTML = "";
  let lineIndex = 0;
  function typeLine() {
    if (lineIndex < INVALID_LINES.length) {
      let p;
      if (lineIndex === INVALID_LINES.length - 1) {
        p = document.createElement("div");
        p.className = "invalid-telegram-line";
        const img = document.createElement("img");
        img.src = "https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg";
        img.alt = "Telegram";
        img.className = "invalid-telegram-logo";
        const link = document.createElement("a");
        link.href = "https://t.me/mybot";
        link.target = "_blank";
        link.textContent = "@mybot";
        p.appendChild(img);
        p.appendChild(link);
        center.appendChild(p);
        return;
      }
      p = document.createElement("div");
      center.appendChild(p);
      let i = 0;
      function typeText() {
        if (i < INVALID_LINES[lineIndex].length) {
          p.innerHTML += INVALID_LINES[lineIndex][i];
          i++;
          setTimeout(typeText, 100);
        } else {
          lineIndex++;
          setTimeout(typeLine, 400);
        }
      }
      typeText();
    }
  }
  typeLine();
}
function safeAtob(token) {
  try {
    const d = decodeURIComponent(token);
    try { return atob(d); } catch { return atob(token); }
  } catch { return atob(token); }
}
function escapeHtml(s) {
  return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : '';
}
function showInvalid() {
  const root = document.getElementById('appRoot');
  root.innerHTML = INVALID_MARKUP;
  setTimeout(startInvalidTyping, 20);
}
function renderValidUI({ taskId, duration, redirectUrl, webhook }) {
  const root = document.getElementById('appRoot');
  root.innerHTML = `
    <div class="top-banner">
      Stay on this page for at least <span id="countdownBanner">${escapeHtml(String(duration))}</span> <span class="seconds">Seconds</span><br>to complete the task
    </div>
    <iframe class="preview" src="${escapeHtml(redirectUrl)}" title="Preview"></iframe>
  `;
  let secondsLeft = parseInt(duration, 10);
  const bannerCountdownEl = document.getElementById('countdownBanner');
  const interval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft < 0) {
      clearInterval(interval);
      completeTask();
      return;
    }
    bannerCountdownEl.textContent = secondsLeft;
  }, 1000);
  let done = false;
  async function completeTask() {
    if (done) return; done = true;
    try {
      await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ webhook, data: { id: taskId } })
      });
    } catch(e){console.error(e);}
    try { window.location.href = redirectUrl; }
    catch { window.open(redirectUrl,'_blank'); }
  }
}
(function main(){
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  if (!token) return showInvalid();
  let decoded;
  try { decoded = safeAtob(token); } catch { return showInvalid(); }
  const parts = decoded.split('#-#');
  if (!parts || parts.length !== 5) return showInvalid();
  const password = (parts[0]||'').trim();
  const taskId = (parts[1]||'').trim();
  const durationStr = (parts[2]||'').trim();
  const redirectUrl = (parts[3]||'').trim();
  const webhook = (parts[4]||'').trim();
  if (password !== 'anonYmous') return showInvalid();
  const duration = parseInt(durationStr,10);
  const valid = Number.isInteger(duration)&&duration>0&&taskId&&redirectUrl&&(redirectUrl.startsWith('http://')||redirectUrl.startsWith('https://'))&&webhook;
  if(!valid) return showInvalid();
  renderValidUI({ taskId, duration, redirectUrl, webhook });
})();
</script>
</body>
</html>
