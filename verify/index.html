<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Captcha Verification</title>

<link href="https://fonts.googleapis.com/css2?family=Wallpoet&family=UnifrakturCook:wght@700&family=Orbitron:wght@900&family=Rubik+Mono+One&family=Black+Ops+One&family=Special+Elite&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  /* --- page / captcha styles (kept your original) --- */
  body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    user-select: none;
    background: linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a);
    color: #fff;
  }
  .captcha-container {
    text-align: center;
    width: 100%;
    max-width: 350px;
    z-index: 2;
  }
  .captcha-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent;
    border-radius: 10px;
    padding: 10px 15px;
    margin-bottom: 20px;
    height: 60px;
    box-shadow: none;
  }
  .captcha-refresh {
    cursor: pointer;
    margin-left: 10px;
    color: #fff;
    font-weight: bold;
    font-size: 1.5em;
    user-select: none;
  }
  .input-wrapper {
    margin-bottom: 10px;
  }
  .input-wrapper input {
    width: 80%;
    max-width: 250px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    text-align: center;
    margin: 0 auto;
    display: block;
  }
  .error {
    color: #ff8a8a;
    font-size: 14px;
    min-height: 16px;
  }
  .btn {
    margin-top: 10px;
    background: #243b77;
    color: #fff;
    border: none;
    padding: 12px 40px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    transition: background 0.3s;
  }
  .btn:hover { background: #1b2f5a; }
  .blurred { filter: blur(6px); pointer-events: none; }

  .loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 9999; text-align: center; }
  .loader .circle { width: 60px; height: 60px; position: relative; animation: rotate 1s linear infinite; }
  .loader .circle span { position: absolute; width: 8px; height: 8px; background: limegreen; border-radius: 50%; }
  .loader .circle span:nth-child(1) { top: 0; left: 26px; }
  .loader .circle span:nth-child(2) { top: 8px; left: 45px; }
  .loader .circle span:nth-child(3) { top: 26px; left: 52px; }
  .loader .circle span:nth-child(4) { top: 45px; left: 45px; }
  .loader .circle span:nth-child(5) { top: 52px; left: 26px; }
  .loader .circle span:nth-child(6) { top: 45px; left: 8px; }
  .loader .circle span:nth-child(7) { top: 26px; left: 0; }
  .loader .circle span:nth-child(8) { top: 8px; left: 8px; }
  @keyframes rotate { 0%{ transform: rotate(0); } 100%{ transform: rotate(360deg); } }

  /* success / vpn / no-internet boxes kept from your original */
  .success-box, .vpn-box, .no-internet-box {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(.7) perspective(700px) rotateX(18deg);
    background: linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a);
    padding: 30px;
    border-radius: 10px;
    border: 1px solid #333;
    text-align: center;
    width: 300px;
    opacity: 0;
    transition: all .45s cubic-bezier(.2, .8, .2, 1);
    z-index: 9998;
  }
  .success-box.show, .vpn-box.show, .no-internet-box.show {
    transform: translate(-50%, -50%) scale(1) perspective(700px) rotateX(0);
    opacity: 1;
  }
  .badge { width: 86px; height: 86px; margin: 0 auto 8px; transform-style: preserve-3d; }

  .vpn-title, .no-internet-title { color: #ffb3b3; margin: 15px 0 5px; font-size: 20px; }
  .success-text { margin: 15px 0 5px; font-size: 20px; color: #9fff9f; }

  /* --- INVALID / "Nothing To Do Here" UI (copied & adapted) --- */
  .invalid-root { all: initial; box-sizing: border-box; }
  .invalid-root * { box-sizing: border-box; }
  .invalid-body {
    margin: 0;
    background: transparent;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
    position: fixed;
    inset: 0;
    z-index: 9999;
    backdrop-filter: blur(2px);
  }
  .invalid-center-message {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 22px;
    font-weight: 800;
    color: #000;
    padding: 22px 36px;
    background: linear-gradient(180deg,#b59a3a,#a07f2a);
    border-radius: 18px;
    animation: invalid-float 3s ease-in-out infinite;
    white-space: pre-line;
    line-height: 1.45;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }
  .invalid-center-message a { color: #000; text-decoration: none; font-weight: 900; }
  .invalid-telegram-line { display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px; }
  .invalid-telegram-logo { width: 28px; height: 28px; filter: drop-shadow(0 1px 0 rgba(255,255,255,0.06)); }
  @keyframes invalid-float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }

  /* hide the captcha when invalid shown */
  .hidden { display:none !important; }
</style>
</head>
<body>

<!-- CAPTCHA UI -->
<div id="mainContent" class="captcha-container">
  <div id="captchaUiArea">
    <div class="captcha-box">
      <canvas id="captchaCanvas" width="200" height="60"></canvas>
      <div class="captcha-refresh" onclick="generateCaptcha()">⟳</div>
    </div>
    <div class="input-wrapper">
      <input type="text" id="captchaInput" placeholder="Type the text exactly as shown">
    </div>
    <div class="error" id="error"></div>
    <button class="btn" id="verifyBtn">Verify</button>
  </div>
</div>

<div class="loader" id="loader">
  <div class="circle">
    <span></span><span></span><span></span><span></span>
    <span></span><span></span><span></span><span></span>
  </div>
</div>

<!-- SUCCESS / VPN / NO INTERNET boxes (kept and slightly adapted) -->
<div class="success-box" id="successBox">
  <div class="badge success-check">
    <div class="medallion" aria-hidden="true" style="width:86px;height:86px;border-radius:50%;background:radial-gradient(120% 120% at 30% 25%, #2b356a 0%, #1c2242 38%, #151a33 66%, #0a0c19 100%);display:grid;place-items:center;">
      <!-- simple check mark -->
      <svg id="successSvg" viewBox="0 0 100 100" width="46" height="46" aria-hidden="true">
        <path class="tick" d="M28 52 L45 68 L74 36" fill="none" stroke="#5af4a6" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="120" stroke-dashoffset="0"></path>
      </svg>
    </div>
  </div>
  <h2 class="success-text">Verification successful!</h2>
  <p>Please return back to the bot</p>
</div>

<div class="vpn-box" id="vpnBox">
  <div class="badge vpn-check">
    <svg id="vpnSvg" class="vpn-svg" viewBox="0 0 100 100" width="86" height="86" fill="none" stroke-width="8" stroke-linecap="round">
      <circle cx="50" cy="50" r="40"></circle>
      <line x1="32" y1="32" x2="68" y2="68"></line>
      <line x1="68" y1="32" x2="32" y2="68"></line>
    </svg>
  </div>
  <h2 class="vpn-title">VPN or Proxy Detected!</h2>
  <p>Please disable your VPN or refresh your internet and try again.</p>
  <button class="btn" id="vpnOkBtn">OK</button>
</div>

<div class="no-internet-box" id="noInternetBox">
  <div class="badge no-internet-check">
    <svg id="noInternetSvg" class="no-internet-svg" viewBox="0 0 100 100" width="86" height="86" fill="none" stroke-width="8" stroke-linecap="round">
      <circle cx="50" cy="50" r="40" transform="rotate(45,50,50)"></circle>
      <line class="first" x1="68" y1="68" x2="32" y2="32"></line>
      <line class="second" x1="68" y1="32" x2="32" y2="68"></line>
    </svg>
  </div>
  <h2 class="no-internet-title">No Internet Connection!</h2>
  <p>Please check your network and try again.</p>
  <button class="btn" id="noInternetOkBtn">OK</button>
</div>

<!-- INVALID MARKUP (injected when token missing/invalid) -->
<!-- We'll inject this programmatically, but keep template here for reference. -->

<script>
  /***********************
   * Captcha utilities
   ***********************/
  const fonts = [
    "Wallpoet", "UnifrakturCook", "Orbitron",
    "Rubik Mono One", "Black Ops One", "Special Elite", "Press Start 2P"
  ];
  let captcha = "";
  function generateCaptcha() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    captcha = "";
    for (let i = 0; i < 5; i++) captcha += chars.charAt(Math.floor(Math.random() * chars.length));
    const canvas = document.getElementById("captchaCanvas");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const font = fonts[Math.floor(Math.random() * fonts.length)];
    ctx.font = `32px '${font}', cursive`;
    ctx.fillStyle = "white";
    ctx.setTransform(1, 0.06 * (Math.random() - 0.5), 0.06 * (Math.random() - 0.5), 1, 0, 0);
    ctx.fillText(captcha, canvas.width / 2, canvas.height / 2);
  }
  generateCaptcha();

  document.getElementById("captchaInput").addEventListener("input", function() {
    const val = this.value;
    const ok = captcha.substring(0, val.length) === val;
    document.getElementById("error").textContent = ok ? "" : "Incorrect";
  });

  /***********************
   * INVALID / "Nothing To Do Here" UI
   ***********************/
  let INVALID_LINES = [
    "Nothing To Do Here!",
    "Join This Bot To",
    "Earn Real Money",
    "@mybot"
  ];

  const INVALID_MARKUP = `
    <div class="invalid-root" id="invalidRoot">
      <div class="invalid-body">
        <div id="centerMessage" class="invalid-center-message"></div>
      </div>
    </div>
  `;

  function safeAtob(token) {
    try {
      const d = decodeURIComponent(token);
      try { return atob(d); } catch { return atob(token); }
    } catch { try { return atob(token); } catch { return null; } }
  }

  function startInvalidTyping() {
    const center = document.getElementById("centerMessage");
    if (!center) return;
    center.innerHTML = "";
    let lineIndex = 0;

    function typeLine() {
      if (lineIndex < INVALID_LINES.length) {
        // last line becomes telegram link row
        if (lineIndex === INVALID_LINES.length - 1) {
          const p = document.createElement("div");
          p.className = "invalid-telegram-line";
          const img = document.createElement("img");
          img.src = "https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg";
          img.alt = "Telegram";
          img.className = "invalid-telegram-logo";
          const link = document.createElement("a");
          link.href = "https://t.me/mybot";
          link.target = "_blank";
          link.textContent = INVALID_LINES[lineIndex];
          p.appendChild(img);
          p.appendChild(link);
          center.appendChild(p);
          return;
        }
        const p = document.createElement("div");
        center.appendChild(p);
        let i = 0;
        function typeText() {
          if (i < INVALID_LINES[lineIndex].length) {
            p.innerHTML += INVALID_LINES[lineIndex][i];
            i++;
            setTimeout(typeText, 100);
          } else {
            lineIndex++;
            setTimeout(typeLine, 420);
          }
        }
        typeText();
      }
    }
    typeLine();
  }

  let invalidShown = false;
  function showInvalid() {
    // hide captcha UI and loader
    document.getElementById("captchaUiArea")?.classList.add("hidden");
    document.getElementById("loader")?.style.setProperty("display", "none");
    // set background to black when showing invalid (requested change)
    document.body.style.background = '#000';
    // inject invalid markup
    if (!document.getElementById('invalidRoot')) {
      const wrap = document.createElement('div');
      wrap.innerHTML = INVALID_MARKUP;
      document.body.appendChild(wrap.firstElementChild);
    }
    invalidShown = true;
    setTimeout(startInvalidTyping, 40);
  }

  /***********************
   * Token validation (same logic as original page)
   ***********************/
  function validateTokenFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    if (!token) return false;
    const decoded = safeAtob(token);
    if (!decoded) return false;
    const parts = decoded.split('#-#');
    if (!parts || parts.length !== 5) return false;

    const timeTimeoutStr = (parts[0]||'').trim();
    // taskId = parts[1], duration = parts[2], redirectUrl = parts[3], webhook = parts[4]
    // If timeTimeout is not only numbers -> invalid
    if (!/^\d+$/.test(timeTimeoutStr)) return false;
    const timeTimeout = parseInt(timeTimeoutStr, 10);
    const now = Date.now();
    // if numeric but >= now -> invalid (same logic)
    if (!isNaN(timeTimeout) && timeTimeout >= now) return false;

    // Basic further checks (duration/redirect/webhook) - keep minimal but helpful
    const durationStr = (parts[2]||'').trim();
    const redirectUrl = (parts[3]||'').trim();
    const webhook = (parts[4]||'').trim();
    const duration = parseInt(durationStr, 10);
    const valid = Number.isInteger(duration) && duration > 0 && redirectUrl && (redirectUrl.startsWith('http://') || redirectUrl.startsWith('https://')) && webhook;
    return !!valid;
  }

  /***********************
   * Show/hide popups & helpers
   ***********************/
  function restartStroke(svgSelector) {
    const svg = document.querySelector(svgSelector);
    if (!svg) return;
    svg.classList.remove("draw");
    void svg.getBoundingClientRect();
    svg.classList.add("draw");
  }

  function showSuccess() {
    document.getElementById("loader").style.display = "none";
    const box = document.getElementById("successBox");
    box.style.display = "block";
    setTimeout(() => {
      box.classList.add("show");
      restartStroke("#successSvg");
    }, 20);
  }

  function showVpn(msg) {
    const box = document.getElementById("vpnBox");
    if (msg) { box.querySelector(".vpn-title").textContent = msg; }
    box.style.display = "block";
    setTimeout(() => {
      box.classList.add("show");
      restartStroke("#vpnSvg");
    }, 20);
  }

  function showNoInternet(msg) {
    const box = document.getElementById("noInternetBox");
    if (msg) box.querySelector('.no-internet-title').textContent = msg;
    box.style.display = "block";
    setTimeout(() => {
      box.classList.add("show");
      restartStroke("#noInternetSvg");
    }, 20);
  }

  document.getElementById("vpnOkBtn").addEventListener("click", () => {
    document.getElementById("vpnBox").classList.remove("show");
    setTimeout(() => { document.getElementById("vpnBox").style.display = "none"; }, 250);
  });
  document.getElementById("noInternetOkBtn").addEventListener("click", () => {
    document.getElementById("noInternetBox").classList.remove("show");
    setTimeout(() => { document.getElementById("noInternetBox").style.display = "none"; }, 250);
  });

  /***********************
   * Verify button handler
   ***********************/
  document.getElementById("verifyBtn").addEventListener("click", async function() {
    // If we previously determined token invalid, avoid verifying (page already shows invalid)
    if (invalidShown) {
      // keep UX consistent: if invalid shown, do nothing (or re-show invalid)
      return;
    }

    // quick client-side online check
    if (!navigator.onLine) {
      // show the nice popup for no internet (requested)
      showNoInternet("No Internet Connection! Please refresh your connection and try again.");
      return;
    }

    const val = document.getElementById("captchaInput").value;
    if (val !== captcha) {
      document.getElementById("error").textContent = "Incorrect";
      return;
    }

    document.getElementById("mainContent").classList.add("blurred");
    document.getElementById("loader").style.display = "block";

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    if (!token) {
      // token missing — show the invalid UI instead of success
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    let webhook;
    try {
      webhook = safeAtob(token);
      if (!webhook) throw new Error('bad token');
    } catch (e) {
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    // Expect webhook string contains expected pattern (keeps your original safety)
    if (
      !webhook.startsWith("https://appapi.bots.business/v1/bots/") ||
      !webhook.includes("command=%2F") ||
      !webhook.includes("user_id=")
    ) {
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    try {
      // ensure we can fetch external IP; network errors fall to catch
      const ipRes = await fetch("https://api.ipify.org?format=json");
      if (!ipRes.ok) throw new Error('ip fetch failed');
      const { ip } = await ipRes.json();

      // call your IP check endpoint (server-side)
      const vpnRes = await fetch("/api/ipcheck?ip=" + ip);
      if (!vpnRes.ok) throw new Error('vpn check failed');
      const vpnData = await vpnRes.json();
      const vpnOn = vpnData.raw?.vpn || vpnData.raw?.tor || vpnData.raw?.active_vpn || vpnData.raw?.active_tor;

      if (vpnOn) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("mainContent").classList.remove("blurred");
        showVpn();
        return;
      }

      const ipInfoRes = await fetch(`https://ipwho.is/${ip}`);
      const ipInfo = ipInfoRes.ok ? await ipInfoRes.json() : { ip };

      const dataToSend = {
        ip: ipInfo.ip,
        country: ipInfo.country,
        countryCode: ipInfo.country_code,
        callingCode: ipInfo.calling_code,
        timezone: ipInfo.timezone?.id
      };

      // send to your backend which forwards to the webhook URL
      await fetch("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ webhook, data: dataToSend })
      });

      // show success
      showSuccess();
    } catch (err) {
      // On any fetch/network/server error show the friendly no-internet popup (as requested)
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      // show a helpful message — user asked 'pop vpn that user should refresh their Internet connection or other good idea.'
      showNoInternet("Connection failed. Please refresh your internet and try again.");
      console.error("Verification error:", err);
    }
  });

  /***********************
   * Init: decide whether to show invalid UI or the captcha
   ***********************/
  (function initPage() {
    // If token invalid or missing -> do not show captcha; show INVALID_LINES UI instead.
    const ok = validateTokenFromUrl();
    if (!ok) {
      // hide the captcha area and show invalid UI
      showInvalid();
      return;
    }
    // else token valid: leave captcha visible and usable
    // restore original background (requested change) so it does not stay black
    document.body.style.background = "linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a)";
    // ensure initial draw flags to avoid SVG errors (kept from original)
    const svg = document.getElementById("successSvg"); if (svg) svg.classList.add("draw");
    const vpn = document.getElementById("vpnSvg"); if (vpn) vpn.classList.add("draw");
    const noNet = document.getElementById("noInternetSvg"); if (noNet) noNet.classList.add("draw");
  })();

  /* safety: block context menu & some shortcuts like original */
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("keydown", e => {
    if ((e.ctrlKey || e.metaKey) && ["c","u","s","p"].includes(e.key.toLowerCase())) e.preventDefault();
  });
</script>
</body>
</html>
