<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Captcha Verification</title>

<link href="https://fonts.googleapis.com/css2?family=Wallpoet&family=UnifrakturCook:wght@700&family=Orbitron:wght@900&family=Rubik+Mono+One&family=Black+Ops+One&family=Special+Elite&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  /* --- page / captcha styles (kept your original) --- */
  body {
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    user-select: none;
    background: linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a);
    color: #fff;
  }
  .captcha-container {
    text-align: center;
    width: 100%;
    max-width: 350px;
    z-index: 2;
  }
  .captcha-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent;
    border-radius: 10px;
    padding: 10px 15px;
    margin-bottom: 20px;
    height: 60px;
    box-shadow: none;
  }
  .captcha-refresh {
    cursor: pointer;
    margin-left: 10px;
    color: #fff;
    font-weight: bold;
    font-size: 1.5em;
    user-select: none;
  }
  .input-wrapper {
    margin-bottom: 10px;
  }
  .input-wrapper input {
    width: 80%;
    max-width: 250px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    text-align: center;
    margin: 0 auto;
    display: block;
  }
  .error {
    color: #ff8a8a;
    font-size: 14px;
    min-height: 16px;
  }
  .btn {
    margin-top: 10px;
    background: #243b77;
    color: #fff;
    border: none;
    padding: 12px 40px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    transition: background 0.3s;
  }
  .btn:hover { background: #1b2f5a; }
  .blurred { filter: blur(6px); pointer-events: none; }

  /* LOADING (replaced rolling circle with LOADING code) */
  .loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 9999; text-align: center; }
  :root{
    --loader-size: 60px;
    --loader-color: #d4af37; /* gold */
    --loader-duration: 1.0s;
  }
  .dots{display:flex;gap:10px;align-items:center; justify-content:center;}
  .dot{
    width:calc(var(--loader-size)/5);
    height:calc(var(--loader-size)/5);
    border-radius:50%;
    background:var(--loader-color);
    opacity:0.95;
    transform:translateY(0);
    animation:jump var(--loader-duration) cubic-bezier(.2,.6,.2,1) infinite;
  }
  .dot:nth-child(1){animation-delay:calc(var(--loader-duration) * -0.18)}
  .dot:nth-child(2){animation-delay:calc(var(--loader-duration) * -0.06)}
  .dot:nth-child(3){animation-delay:calc(var(--loader-duration) * 0.06)}
  @keyframes jump{
    0%,100%{transform:translateY(0);opacity:0.85}
    50%{transform:translateY(-12px);opacity:1}
  }

  /* success / vpn / no-internet boxes unified size */
  .success-box, .vpn-box, .no-internet-box {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(.95);
    background: linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #333;
    text-align: center;
    width: 340px;
    height: 220px;          /* unified height */
    box-sizing: border-box;
    opacity: 0;
    transition: all .28s cubic-bezier(.2, .8, .2, 1);
    z-index: 9998;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .success-box.show, .vpn-box.show, .no-internet-box.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  .badge { width: 86px; height: 86px; margin: 0 auto 8px; transform-style: preserve-3d; display:flex; align-items:center; justify-content:center; }

  .vpn-title, .no-internet-title { color: #ffb3b3; margin: 6px 0 5px; font-size: 18px; font-weight: 800; }
  .success-text { margin: 6px 0 5px; font-size: 18px; color: #9fff9f; font-weight:700; }
  .popup-sub { font-size: 14px; color: #ddd; padding: 0 6px; line-height:1.4; }

  /* static ❌ icon style (no animation/draw) */
  .icon-x { width:86px; height:86px; display:inline-block; border-radius:50%; background: radial-gradient(circle at 30% 25%, #2b356a 0%, #1c2242 38%, #151a33 66%, #0a0c19 100%); display:grid; place-items:center; }
  .icon-x svg { width:48px; height:48px; }

  /* success tick kept as-is (unchanged) */
  .medallion { width:86px;height:86px;border-radius:50%;background:radial-gradient(120% 120% at 30% 25%, #2b356a 0%, #1c2242 38%, #151a33 66%, #0a0c19 100%);display:grid;place-items:center; }

  /* --- INVALID / "Nothing To Do Here" UI (copied & adapted) --- */
  .invalid-root { all: initial; box-sizing: border-box; }
  .invalid-root * { box-sizing: border-box; }
  .invalid-body {
    margin: 0;
    background: transparent;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
    position: fixed;
    inset: 0;
    z-index: 9999;
    backdrop-filter: blur(2px);
  }
  .invalid-center-message {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 22px;
    font-weight: 800;
    color: #000;
    padding: 22px 36px;
    background: linear-gradient(180deg,#b59a3a,#a07f2a);
    border-radius: 18px;
    animation: invalid-float 3s ease-in-out infinite;
    white-space: pre-line;
    line-height: 1.45;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }
  .invalid-center-message a { color: #000; text-decoration: none; font-weight: 900; }
  .invalid-telegram-line { display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px; }
  .invalid-telegram-logo { width: 28px; height: 28px; filter: drop-shadow(0 1px 0 rgba(255,255,255,0.06)); }
  @keyframes invalid-float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-8px);} }

  /* hide the captcha when invalid shown */
  .hidden { display:none !important; }
</style>
</head>
<body>

<!-- CAPTCHA UI -->
<div id="mainContent" class="captcha-container">
  <div id="captchaUiArea">
    <div class="captcha-box">
      <canvas id="captchaCanvas" width="200" height="60"></canvas>
      <div class="captcha-refresh" onclick="generateCaptcha()">⟳</div>
    </div>
    <div class="input-wrapper">
      <input type="text" id="captchaInput" placeholder="Type the text exactly as shown">
    </div>
    <div class="error" id="error"></div>
    <button class="btn" id="verifyBtn">Verify</button>
  </div>
</div>

<!-- LOADING - replaced with 3-dot LOADING -->
<div class="loader" id="loader" aria-hidden="true">
  <div class="dots" role="status" aria-live="polite">
    <div class="dot" aria-hidden="true"></div>
    <div class="dot" aria-hidden="true"></div>
    <div class="dot" aria-hidden="true"></div>
  </div>
</div>

<!-- SUCCESS / VPN / NO INTERNET boxes (unified sizes) -->
<div class="success-box" id="successBox" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="medallion" aria-hidden="true">
    <!-- simple check mark -->
    <svg id="successSvg" viewBox="0 0 100 100" width="46" height="46" aria-hidden="true">
      <path class="tick" d="M28 52 L45 68 L74 36" fill="none" stroke="#5af4a6" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  </div>
  <h2 class="success-text">Verification successful!</h2>
  <p class="popup-sub">Please return back to the bot</p>
</div>

<div class="vpn-box" id="vpnBox" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="icon-x" aria-hidden="true">
    <!-- static ❌ -->
    <svg viewBox="0 0 100 100" fill="none" aria-hidden="true">
      <circle cx="50" cy="50" r="40" stroke="#aa6161" stroke-width="6"></circle>
      <line x1="34" y1="34" x2="66" y2="66" stroke="#ff9b9b" stroke-width="7" stroke-linecap="round"></line>
      <line x1="66" y1="34" x2="34" y2="66" stroke="#ff9b9b" stroke-width="7" stroke-linecap="round"></line>
    </svg>
  </div>
  <h2 class="vpn-title" id="vpnTitle">VPN or Proxy Detected!</h2>
  <p class="popup-sub" id="vpnSub">Please disable your VPN or refresh your internet and try again.</p>
  <button class="btn" id="vpnOkBtn">OK</button>
</div>

<div class="no-internet-box" id="noInternetBox" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="icon-x" aria-hidden="true">
    <!-- static ❌ (same style) -->
    <svg viewBox="0 0 100 100" fill="none" aria-hidden="true">
      <circle cx="50" cy="50" r="40" stroke="#aa6161" stroke-width="6"></circle>
      <line x1="34" y1="34" x2="66" y2="66" stroke="#ff9b9b" stroke-width="7" stroke-linecap="round"></line>
      <line x1="66" y1="34" x2="34" y2="66" stroke="#ff9b9b" stroke-width="7" stroke-linecap="round"></line>
    </svg>
  </div>
  <h2 class="no-internet-title" id="noNetTitle">No Internet Connection!</h2>
  <p class="popup-sub" id="noNetSub">Please check your network and try again.</p>
  <button class="btn" id="noInternetOkBtn">OK</button>
</div>

<!-- INVALID MARKUP (injected when token missing/invalid) -->
<!-- We'll inject this programmatically, but keep template here for reference. -->

<script>
  /***********************
   * Captcha utilities
   ***********************/
  const fonts = [
    "Wallpoet", "UnifrakturCook", "Orbitron",
    "Rubik Mono One", "Black Ops One", "Special Elite", "Press Start 2P"
  ];
  let captcha = "";
  function generateCaptcha() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    captcha = "";
    for (let i = 0; i < 5; i++) captcha += chars.charAt(Math.floor(Math.random() * chars.length));
    const canvas = document.getElementById("captchaCanvas");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const font = fonts[Math.floor(Math.random() * fonts.length)];
    ctx.font = `32px '${font}', cursive`;
    ctx.fillStyle = "white";
    ctx.setTransform(1, 0.06 * (Math.random() - 0.5), 0.06 * (Math.random() - 0.5), 1, 0, 0);
    ctx.fillText(captcha, canvas.width / 2, canvas.height / 2);
  }
  generateCaptcha();

  document.getElementById("captchaInput").addEventListener("input", function() {
    const val = this.value;
    const ok = captcha.substring(0, val.length) === val;
    document.getElementById("error").textContent = ok ? "" : "Incorrect";
  });

  /***********************
   * INVALID / "Nothing To Do Here" UI
   ***********************/
  let INVALID_LINES = [
    "Nothing To Do Here!",
    "Join This Bot To",
    "Earn Real Money",
    "@mybot"
  ];

  const INVALID_MARKUP = `
    <div class="invalid-root" id="invalidRoot">
      <div class="invalid-body">
        <div id="centerMessage" class="invalid-center-message"></div>
      </div>
    </div>
  `;

  function safeAtob(token) {
    try {
      const d = decodeURIComponent(token);
      try { return atob(d); } catch { return atob(token); }
    } catch { try { return atob(token); } catch { return null; } }
  }

  function startInvalidTyping() {
    const center = document.getElementById("centerMessage");
    if (!center) return;
    center.innerHTML = "";
    let lineIndex = 0;

    function typeLine() {
      if (lineIndex < INVALID_LINES.length) {
        // last line becomes telegram link row
        if (lineIndex === INVALID_LINES.length - 1) {
          const p = document.createElement("div");
          p.className = "invalid-telegram-line";
          const img = document.createElement("img");
          img.src = "https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg";
          img.alt = "Telegram";
          img.className = "invalid-telegram-logo";
          const link = document.createElement("a");
          link.href = "https://t.me/mybot";
          link.target = "_blank";
          link.textContent = INVALID_LINES[lineIndex];
          p.appendChild(img);
          p.appendChild(link);
          center.appendChild(p);
          return;
        }
        const p = document.createElement("div");
        center.appendChild(p);
        let i = 0;
        function typeText() {
          if (i < INVALID_LINES[lineIndex].length) {
            p.innerHTML += INVALID_LINES[lineIndex][i];
            i++;
            setTimeout(typeText, 100);
          } else {
            lineIndex++;
            setTimeout(typeLine, 420);
          }
        }
        typeText();
      }
    }
    typeLine();
  }

  let invalidShown = false;
  function showInvalid() {
    // hide captcha UI and loader
    document.getElementById("captchaUiArea")?.classList.add("hidden");
    document.getElementById("loader")?.style.setProperty("display", "none");
    // set background to black when showing invalid (requested change)
    document.body.style.background = '#000';
    // inject invalid markup
    if (!document.getElementById('invalidRoot')) {
      const wrap = document.createElement('div');
      wrap.innerHTML = INVALID_MARKUP;
      document.body.appendChild(wrap.firstElementChild);
    }
    invalidShown = true;
    setTimeout(startInvalidTyping, 40);
  }

  /***********************
   * Token validation (simplified — token encodes webhook only)
   ***********************/
  function validateTokenFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    if (!token) return false;
    const decoded = safeAtob(token);
    if (!decoded) return false;
    const webhook = decoded.trim();
    // quick safety check: webhook must look like bots.business URL with user_id and command param
    if (!webhook.startsWith("https://") || (!webhook.includes("bots.business") && !webhook.includes("api.bots.business") && !webhook.includes("appapi.bots.business"))) {
      return false;
    }
    if (!webhook.includes("user_id=") || !webhook.includes("command=")) return false;
    // token decodes to webhook — valid
    return true;
  }

  /***********************
   * Show/hide popups & helpers
   ***********************/
  function showSuccess() {
    document.getElementById("loader").style.display = "none";
    const box = document.getElementById("successBox");
    box.style.display = "flex";
    setTimeout(() => {
      box.classList.add("show");
    }, 20);
  }

  function showVpn(msgTop, msgSub) {
    const box = document.getElementById("vpnBox");
    if (msgTop) { box.querySelector(".vpn-title").textContent = msgTop; }
    if (msgSub) { box.querySelector(".vpn-sub")?.remove(); /* keep existing sub */ }
    box.querySelector("#vpnSub")?.textContent = msgSub || "Please disable your VPN or refresh your internet and try again.";
    box.style.display = "flex";
    setTimeout(() => {
      box.classList.add("show");
    }, 20);
  }

  function showNoInternet(msgTop, msgSub) {
    const box = document.getElementById("noInternetBox");
    if (msgTop) box.querySelector('.no-internet-title').textContent = msgTop;
    if (msgSub) box.querySelector('.popup-sub').textContent = msgSub;
    box.style.display = "flex";
    setTimeout(() => {
      box.classList.add("show");
    }, 20);
  }

  document.getElementById("vpnOkBtn").addEventListener("click", () => {
    document.getElementById("vpnBox").classList.remove("show");
    setTimeout(() => { document.getElementById("vpnBox").style.display = "none"; }, 250);
  });
  document.getElementById("noInternetOkBtn").addEventListener("click", () => {
    document.getElementById("noInternetBox").classList.remove("show");
    setTimeout(() => { document.getElementById("noInternetBox").style.display = "none"; }, 250);
  });

  /***********************
   * fetchWithTimeout helper to detect slow/failed network
   ***********************/
  function fetchWithTimeout(resource, options = {}) {
    const { timeout = 10000 } = options; // 10s default
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  /***********************
   * Verify button handler
   ***********************/
  document.getElementById("verifyBtn").addEventListener("click", async function() {
    // If we previously determined token invalid, avoid verifying (page already shows invalid)
    if (invalidShown) {
      return;
    }

    // quick client-side online check
    if (!navigator.onLine) {
      showNoInternet("No Internet Connection!", "Please refresh your connection and try again.");
      return;
    }

    const val = document.getElementById("captchaInput").value;
    if (val !== captcha) {
      document.getElementById("error").textContent = "Incorrect";
      return;
    }

    document.getElementById("mainContent").classList.add("blurred");
    document.getElementById("loader").style.display = "block";

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");

    if (!token) {
      // token missing — show the invalid UI instead of success
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    let webhook;
    try {
      webhook = safeAtob(token);
      if (!webhook) throw new Error('bad token');
    } catch (e) {
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    // Expect webhook string contains expected pattern (keeps your original safety)
    if (
      !webhook.startsWith("https://") ||
      (!webhook.includes("bots.business") && !webhook.includes("appapi.bots.business")) ||
      !webhook.includes("command=") ||
      !webhook.includes("user_id=")
    ) {
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showInvalid();
      return;
    }

    try {
      // ensure we can fetch external IP; network errors/timeouts fall to catch
      const ipRes = await fetchWithTimeout("https://api.ipify.org?format=json", { timeout: 10000 });
      if (!ipRes.ok) throw new Error('ip fetch failed');
      const { ip } = await ipRes.json();

      // call your IP check endpoint (server-side)
      const vpnRes = await fetchWithTimeout("/api/ipcheck?ip=" + encodeURIComponent(ip), { timeout: 10000 });
      if (!vpnRes.ok) {
        // If server returned 502 with extra info, try to parse JSON body; otherwise treat as failure
        let parsed = null;
        try { parsed = await vpnRes.json(); } catch (e) { parsed = null; }
        // if parsed contains ipInfo, go to the "all keys failed" flow below
        if (parsed && parsed.allKeysFailed) {
          // show special "unable to verify" popup, send ip info to /api/send
          document.getElementById("loader").style.display = "none";
          document.getElementById("mainContent").classList.remove("blurred");

          const ipInfo = parsed.ipInfo || { ip };
          showVpn("Unable to verify you at the moment!", "Please go back to the bot and re-do the verification later when it's available again.");
          // forward the ip info to /api/send so you receive it on the bot side
          try {
            await fetchWithTimeout("/api/send", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ webhook, data: ipInfo }),
              timeout: 10000
            });
          } catch (err) {
            // If sending fails, show network error popup
            showNoInternet("Something went wrong!", "Please check your network and try again.");
            console.error("Forwarding ipInfo failed:", err);
          }
          return;
        } else {
          // generic failure (e.g., server outage) — treat as network problem
          throw new Error('vpn check failed');
        }
      }

      const vpnData = await vpnRes.json();
      // if the ipcheck returns explicit vpn result
      const vpnOn = vpnData.vpn === true || vpnData.proxy === true || vpnData.tor === true || vpnData.isProxy === true;

      if (vpnOn) {
        document.getElementById("loader").style.display = "none";
        document.getElementById("mainContent").classList.remove("blurred");
        showVpn(); // default vpn message
        return;
      }

      // If ipcheck succeeded but didn't mark VPN, fetch ip info for sending
      let ipInfo = { ip };
      try {
        const ipInfoRes = await fetchWithTimeout(`https://ipwho.is/${ip}`, { timeout: 10000 });
        ipInfo = ipInfoRes.ok ? await ipInfoRes.json() : { ip };
      } catch (e) {
        // If ipwho.is is slow/unavailable, still continue with minimal info
        ipInfo = { ip };
      }

      // send to your backend which forwards to the webhook URL
      await fetchWithTimeout("/api/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ webhook, data: {
          ip: ipInfo.ip,
          country: ipInfo.country,
          countryCode: ipInfo.country_code,
          callingCode: ipInfo.calling_code,
          timezone: ipInfo.timezone?.id
        } }),
        timeout: 10000
      });

      // show success
      showSuccess();
    } catch (err) {
      // On any fetch/network/server error show the friendly no-internet popup
      document.getElementById("loader").style.display = "none";
      document.getElementById("mainContent").classList.remove("blurred");
      showNoInternet("Something went wrong!", "Please check your network and try again.");
      console.error("Verification error:", err);
    }
  });

  /***********************
   * Init: decide whether to show invalid UI or the captcha
   ***********************/
  (function initPage() {
    const ok = validateTokenFromUrl();
    if (!ok) {
      showInvalid();
      return;
    }
    // else token valid: leave captcha visible and usable
    document.body.style.background = "linear-gradient(180deg, #0d1b2a, #1b263b, #0d1b2a)";
  })();

  /* safety: block context menu & some shortcuts like original */
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("keydown", e => {
    if ((e.ctrlKey || e.metaKey) && ["c","u","s","p"].includes(e.key.toLowerCase())) e.preventDefault();
  });
</script>
</body>
</html>
